<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Formulaire de Dépense</title>

<style>
/* CSS STRICTEMENT IDENTIQUE À TON CODE */
body {
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #f4f4f4;
}
h1 {
    color: #333;
    text-align: center;
}
form {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-width: 600px;
    margin: auto;
}
label {
    display: block;
    margin: 10px 0 5px;
}
input[type="text"],
input[type="date"],
select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
}
button {
    padding: 10px 15px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
    transition: background-color 0.3s;
    width: 100%;
}
button:hover {
    background-color: #218838;
}
#loader {
    display: none;
    color: #007bff;
    text-align: center;
    margin-top: 10px;
}
.autocomplete-suggestion {
    cursor: pointer;
    background-color: #f1f1f1;
    padding: 5px;
    border: 1px solid #ccc;
}
.autocomplete-suggestion:hover {
    background-color: #e0e0e0;
}
#suggestions {
    position: absolute;
    border: 1px solid #ccc;
    z-index: 999;
    background: white;
    max-height: 200px;
    overflow-y: auto;
    width: calc(100% - 22px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    margin-top: -1px;
}
.history {
    margin-top: 30px;
    padding: 15px;
    background: #fafafa;
    border: 1px solid #ddd;
    border-radius: 8px;
}
.history h2 {
    margin-bottom: 10px;
    font-size: 1.2em;
}
.history-item {
    margin-bottom: 5px;
    padding: 10px;
    background: white;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.history-item span {
    display: block;
}
</style>
</head>

<body>

<h1>Ajouter une Dépense</h1>

<form id="depenseForm">
    <label>Date :</label>
    <input type="date" id="date" name="date" required>

    <label>Compte :</label>
    <select id="compte" name="compte" required></select>

    <label>Banque :</label>
    <select id="banque" name="banque" required></select>

    <label>Code :</label>
    <select id="code" name="code" required></select>

    <label>Motif :</label>
    <input type="text" id="motif" name="motif" required autocomplete="off">
    <div id="suggestions"></div>

    <label>Montant :</label>
    <input type="text" id="montant" name="montant" value="0,0" required>

    <label>État :</label>
    <select id="etat" name="etat" required></select>

    <label>Type :</label>
    <select id="type" name="type" required></select>

    <button type="submit">Soumettre</button>
    <div id="loader">Envoi en cours...</div>
</form>

<div class="history">
    <h2>Historique des dernières opérations</h2>
    <div id="historyList"></div>
</div>

<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbyz3WM7Rys0nQATO6KPIlXJmDUnp3OXeYJj4SX3KP1AoR2UlP5TmynWj18KJP8bL8ocnA/exec';
const form = document.getElementById('depenseForm');
const motifInput = document.getElementById('motif');
const suggestionBox = document.getElementById('suggestions');
let motifs = [];

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    loadHistory();
});

/* =============================
   PRÉREMPLISSAGE GOOGLE SHEETS
============================= */
fetch(scriptURL + '?action=getOptions')
    .then(r => r.json())
    .then(options => {
        populateSelect('etat', options.etat, true);
        populateSelect('banque', options.banque);
        populateSelect('type', options.type, true);
        populateSelect('code', options.code);
        populateSelect('compte', options.compte);
        motifs = options.motif;
    });

function populateSelect(id, values, dash=false) {
    const s = document.getElementById(id);
    s.innerHTML = '';
    if (dash) s.innerHTML += '<option value="-">-</option>';
    values.forEach(v => s.innerHTML += `<option value="${v}">${v}</option>`);
}

/* =============================
   AUTOCOMPLÉTION MOTIF
============================= */
motifInput.addEventListener('input', () => {
    const value = motifInput.value.toLowerCase();
    suggestionBox.innerHTML = '';

    if (!value) return;

    motifs
        .filter(m => m.toLowerCase().includes(value))
        .forEach(m => {
            const div = document.createElement('div');
            div.textContent = m;
            div.className = 'autocomplete-suggestion';
            div.onclick = () => {
                motifInput.value = m;
                suggestionBox.innerHTML = '';
            };
            suggestionBox.appendChild(div);
        });
});

/* =============================
   ENVOI ROBUSTE
============================= */
function fetchWithTimeout(url, options, timeout = 10000) {
    return Promise.race([
        fetch(url, options),
        new Promise((_, reject) =>
            setTimeout(() => reject(new Error("Timeout réseau")), timeout)
        )
    ]);
}

form.addEventListener('submit', async e => {
    e.preventDefault();

    const loader = document.getElementById('loader');
    const btn = form.querySelector('button');

    loader.style.display = 'block';
    btn.disabled = true;

    try {
        const formData = new FormData(form);
        const response = await fetchWithTimeout(scriptURL, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();
        if (!result.success) throw new Error(result.error);

        alert("Dépense ajoutée");
        saveToHistory(formData);
        form.reset();
        suggestionBox.innerHTML = '';
        loadHistory();

    } catch (err) {
        alert("Erreur : " + err.message);
    } finally {
        loader.style.display = 'none';
        btn.disabled = false;
    }
});

/* =============================
   HISTORIQUE LOCAL (IDENTIQUE)
============================= */
function saveToHistory(formData) {
    const operation = {
        date: formData.get('date'),
        compte: formData.get('compte'),
        banque: formData.get('banque'),
        code: formData.get('code'),
        motif: formData.get('motif'),
        montant: formData.get('montant'),
        etat: formData.get('etat'),
        type: formData.get('type')
    };

    let history = JSON.parse(localStorage.getItem('depenseHistory')) || [];
    history.unshift(operation);
    if (history.length > 10) history.pop();
    localStorage.setItem('depenseHistory', JSON.stringify(history));
}

function loadHistory() {
    const list = document.getElementById('historyList');
    list.innerHTML = '';

    const history = JSON.parse(localStorage.getItem('depenseHistory')) || [];
    history.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
            <span><strong>Date:</strong> ${item.date}</span>
            <span><strong>Compte:</strong> ${item.compte}</span>
            <span><strong>Banque:</strong> ${item.banque}</span>
            <span><strong>Code:</strong> ${item.code}</span>
            <span><strong>Motif:</strong> ${item.motif}</span>
            <span><strong>Montant:</strong> ${item.montant}</span>
            <span><strong>État:</strong> ${item.etat}</span>
            <span><strong>Type:</strong> ${item.type}</span>
        `;
        list.appendChild(div);
    });
}
</script>

</body>
</html>
